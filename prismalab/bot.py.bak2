#!/usr/bin/env python3
"""
PrismaLab ‚Äî Telegram-–±–æ—Ç —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ (Astria, KIE).

–ó–∞–ø—É—Å–∫ (–∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è):
  python3 -m prismalab.bot
"""

from __future__ import annotations

import asyncio
import io
import logging
import os
import zipfile
import secrets
from typing import Any

from PIL import Image, ImageOps
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.constants import ChatAction
from telegram.error import TimedOut
from telegram.ext import (
    Application,
    CallbackQueryHandler,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    filters,
)

from prismalab.astria_client import (
    AstriaError,
    AstriaTuneResult,
    create_faceid_tune_and_wait as astria_create_faceid_tune_and_wait,
    download_first_image_bytes as astria_download_first_image_bytes,
    run_prompt_and_wait as astria_run_prompt_and_wait,
)
from prismalab.kie_client import (
    KieError,
    download_image_bytes as kie_download_image_bytes,
    run_task_and_wait as kie_run_task_and_wait,
    upload_file_base64 as kie_upload_file_base64,
)
from prismalab.settings import load_settings
from prismalab.styles import STYLES, get_style
from prismalab.storage import PrismaLabStore
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger("prismalab")
# –í–∞–∂–Ω–æ: httpx –Ω–∞ INFO –ª–æ–≥–∏—Ä—É–µ—Ç URL Telegram API, –≥–¥–µ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞.
logging.getLogger("httpx").setLevel(logging.WARNING)


USERDATA_PHOTO_FILE_IDS = "prismalab_photo_file_ids"
USERDATA_ASTRIA_FACEID_FILE_IDS = "prismalab_astria_faceid_file_ids"
USERDATA_ASTRIA_LORA_FILE_IDS = "prismalab_astria_lora_file_ids"
USERDATA_NANO_BANANA_FILE_IDS = "prismalab_nano_banana_file_ids"
USERDATA_LAST_ASTRIA_RESULT_BYTES = "prismalab_last_astria_result_bytes"  # –î–ª—è –∫–Ω–æ–ø–∫–∏ "–£–ª—É—á—à–∏—Ç—å"
USERDATA_MODE = "prismalab_mode"  # normal | astria_faceid | astria_lora
USERDATA_JOB_LOCK = "prismalab_job_lock"
USERDATA_PROMPT_STRENGTH = "prismalab_prompt_strength"
USERDATA_USE_PERSONAL = "prismalab_use_personal"
USERDATA_SUBJECT_GENDER = "prismalab_subject_gender"  # male | female | None

store = PrismaLabStore()


def _round_to_64(x: float) -> int:
    return max(64, int(round(x / 64.0)) * 64)

def _ceil_to_64(x: int) -> int:
    # –í—Å–µ–≥–¥–∞ –æ–∫—Ä—É–≥–ª—è–µ–º –í–í–ï–†–•, —á—Ç–æ–±—ã –Ω–µ —É–∂–∏–º–∞—Ç—å –∏ –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–µ—Ç–∞–ª–∏ –ª–∏—Ü–∞.
    return max(64, ((max(1, int(x)) + 63) // 64) * 64)


def _prepare_image_for_photomaker(image_bytes: bytes) -> bytes:
    """
    –î–ª—è identity-preserving –º–æ–¥–µ–ª–µ–π –ª—É—á—à–µ –ù–ï –¥–µ–ª–∞—Ç—å —Ü–µ–Ω—Ç—Ä-–∫—Ä–æ–ø (–º–æ–∂–µ—Ç —Å—Ä–µ–∑–∞—Ç—å –≤–æ–ª–æ—Å—ã/–∫–æ–Ω—Ç—É—Ä –ª–∏—Ü–∞).
    –î–µ–ª–∞–µ–º –º—è–≥–∫–∏–π resize (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏), –º–∞–∫—Å–∏–º—É–º –ø–æ –¥–ª–∏–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ 1024, –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º PNG.
    """
    img = Image.open(io.BytesIO(image_bytes))
    img = ImageOps.exif_transpose(img)
    img = img.convert("RGB")
    img.thumbnail((1024, 1024), Image.LANCZOS)
    out = io.BytesIO()
    img.save(out, format="PNG", optimize=True)
    return out.getvalue()


def _prepare_image_for_instantid(image_bytes: bytes) -> tuple[bytes, int, int]:
    """
    InstantID / SDXL –æ–±—ã—á–Ω–æ —Ç—Ä–µ–±—É—é—Ç —à–∏—Ä–∏–Ω—É/–≤—ã—Å–æ—Ç—É –∫—Ä–∞—Ç–Ω—ã–µ 64.
    –î–µ–ª–∞–µ–º resize –±–µ–∑ –∫—Ä–æ–ø–∞ + –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–æ –∫—Ä–∞—Ç–Ω–æ—Å—Ç–∏ 64 (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏ –ª–∏—Ü–∞).
    """
    img = Image.open(io.BytesIO(image_bytes))
    img = ImageOps.exif_transpose(img)
    img = img.convert("RGB")
    img.thumbnail((1024, 1024), Image.LANCZOS)
    w, h = img.size
    tw = _ceil_to_64(w)
    th = _ceil_to_64(h)

    # –í–ê–ñ–ù–û: ImageOps.pad –º–æ–∂–µ—Ç –ö–†–û–ü–ê–¢–¨, –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º canvas –≤—Ä—É—á–Ω—É—é (—Ç–æ–ª—å–∫–æ padding).
    canvas = Image.new("RGB", (tw, th), (0, 0, 0))
    x = (tw - w) // 2
    y = (th - h) // 2
    canvas.paste(img, (x, y))

    out = io.BytesIO()
    canvas.save(out, format="PNG", optimize=True)
    return out.getvalue(), tw, th


def _prepare_image_for_instantid_zoom(image_bytes: bytes, *, zoom: float) -> tuple[bytes, int, int]:
    """
    –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ñ–æ—Ç–æ (—Å–∂–∞—Ç—ã—Ö Telegram):
    –µ—Å–ª–∏ –¥–µ—Ç–µ–∫—Ç–æ—Ä –ª–∏—Ü–∞ –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –ø—Ä–æ–±—É–µ–º —á—É—Ç—å –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å —Ü–µ–Ω—Ç—Ä –∫–∞–¥—Ä–∞.
    """
    try:
        z = float(zoom)
    except Exception:
        z = 1.0
    if z <= 1.0:
        return _prepare_image_for_instantid(image_bytes)

    img = Image.open(io.BytesIO(image_bytes))
    img = ImageOps.exif_transpose(img)
    img = img.convert("RGB")
    img.thumbnail((1024, 1024), Image.LANCZOS)

    w, h = img.size
    cw = max(64, int(round(w / z)))
    ch = max(64, int(round(h / z)))
    left = max(0, (w - cw) // 2)
    top = max(0, (h - ch) // 2)
    cropped = img.crop((left, top, left + cw, top + ch))

    w2, h2 = cropped.size
    tw = _ceil_to_64(w2)
    th = _ceil_to_64(h2)
    canvas = Image.new("RGB", (tw, th), (0, 0, 0))
    x = (tw - w2) // 2
    y = (th - h2) // 2
    canvas.paste(cropped, (x, y))

    out = io.BytesIO()
    canvas.save(out, format="PNG", optimize=True)
    return out.getvalue(), tw, th


def _postprocess_output(style_id: str, out_bytes: bytes) -> bytes:
    try:
        img = Image.open(io.BytesIO(out_bytes))
        img.load()
    except Exception as e:
        raise ValueError("API –≤–µ—Ä–Ω—É–ª –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.") from e
    if style_id != "noir":
        return out_bytes
    try:
        img = img.convert("L")
        out = io.BytesIO()
        img.save(out, format="PNG", optimize=True)
        return out.getvalue()
    except Exception as e:
        raise ValueError("–ù–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.") from e

def _guess_aspect_ratio(w: int, h: int) -> str:
    # –ø—Ä–æ—Å—Ç–∞—è –∫–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è –ø–æ–¥ —Ç–∏–ø–∏—á–Ω—ã–µ aspect_ratio Flux
    r = w / h if h else 1.0
    if r > 1.6:
        return "16:9"
    if r > 1.35:
        return "3:2"
    if r > 1.15:
        return "4:3"
    if r < 0.62:
        return "9:16"
    if r < 0.75:
        return "2:3"
    if r < 0.87:
        return "3:4"
    return "1:1"


def _format_strength(x: float) -> str:
    return f"{x:.2f}".rstrip("0").rstrip(".")

def _subject_prompt_prefix(g: str | None) -> str:
    if g == "male":
        return "photorealistic portrait photo of an adult man, male"
    if g == "female":
        return "photorealistic portrait photo of an adult woman, female"
    return "photorealistic portrait photo of a person"


def _instantid_subject(g: str | None) -> str:
    # –î–ª—è InstantID –ª—É—á—à–µ –Ω–µ ‚Äú–ø–æ—Ä—Ç—Ä–µ—Ç–∏—Ç—å‚Äù –ø—Ä–æ–º–ø—Ç–æ–º, –∞ –æ–ø–∏—Å—ã–≤–∞—Ç—å ‚Äú—á–µ–ª–æ–≤–µ–∫ + —Å—Ü–µ–Ω–∞/—Å—Ç–∏–ª—å‚Äù.
    if g == "male":
        return "a man"
    if g == "female":
        return "a woman"
    return "a person"


def _subject_negative_lock(g: str | None) -> str:
    if g == "male":
        return "female, woman, girl, breasts, cleavage, lipstick, makeup, dress"
    if g == "female":
        return "male, man, boy, beard, mustache"
    return ""

def _is_personal_enabled(context: ContextTypes.DEFAULT_TYPE) -> bool:
    # None => —Å—á–∏—Ç–∞–µ–º –≤–∫–ª—é—á–µ–Ω–æ (–µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ–æ–±—â–µ –µ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å)
    return context.user_data.get(USERDATA_USE_PERSONAL) is not False


def _personal_label(enabled: bool) -> str:
    return "‚≠êÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è: –í–∫–ª" if enabled else "‚≠êÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è: –í—ã–∫–ª"

async def _safe_get_file_bytes(
    bot: Any,
    file_id: str,
    *,
    max_retries: int = 2,  # –£–º–µ–Ω—å—à–∏–ª –¥–æ 2 –ø–æ–ø—ã—Ç–æ–∫
    timeout: int = 20,  # –£–º–µ–Ω—å—à–∏–ª –¥–æ 20 —Å–µ–∫—É–Ω–¥
) -> bytes:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ Telegram —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ retry.
    –ü–†–û–°–¢–ê–Ø –≤–µ—Ä—Å–∏—è –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ë—Ä—Ç–æ–∫.
    """
    logger.info(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ {file_id[:15]}...")
    
    for attempt in range(max_retries):
        try:
            logger.info(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}: –≤—ã–∑—ã–≤–∞—é get_file...")
            tg_file = await bot.get_file(file_id, read_timeout=timeout, write_timeout=timeout, connect_timeout=timeout)
            
            logger.info(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] get_file OK, –≤—ã–∑—ã–≤–∞—é download_as_bytearray...")
            image_bytes = bytes(await tg_file.download_as_bytearray(read_timeout=timeout, write_timeout=timeout, connect_timeout=timeout))
            
            logger.info(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] ‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω! –†–∞–∑–º–µ—Ä: {len(image_bytes)} –±–∞–π—Ç")
            return image_bytes
            
        except (TimedOut, asyncio.TimeoutError) as e:
            error_type = "TimedOut" if isinstance(e, TimedOut) else "asyncio.TimeoutError"
            logger.warning(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] ‚ùå {error_type} –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}/{max_retries}")
            if attempt < max_retries - 1:
                wait_time = 3
                logger.info(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] –ñ–¥—É {wait_time}—Å –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...")
                await asyncio.sleep(wait_time)
            else:
                logger.error(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] ‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
                raise
        except Exception as e:
            logger.warning(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] ‚ùå –û—à–∏–±–∫–∞ {type(e).__name__}: {e} –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}/{max_retries}")
            if attempt < max_retries - 1:
                wait_time = 3
                logger.info(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] –ñ–¥—É {wait_time}—Å –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...")
                await asyncio.sleep(wait_time)
            else:
                logger.error(f"[–°–ö–ê–ß–ò–í–ê–ù–ò–ï] ‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫: {type(e).__name__}: {e}")
                raise


async def _safe_send_document(
    bot: Any,
    chat_id: int,
    document: io.BytesIO,
    caption: str,
    *,
    max_retries: int = 3,
    timeout: int = 90,
) -> None:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ retry.
    –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–±—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ —Ñ–æ—Ç–æ.
    """
    document.seek(0)
    
    for attempt in range(max_retries):
        try:
            await bot.send_document(
                chat_id=chat_id,
                document=document,
                caption=caption,
                read_timeout=timeout,
                write_timeout=timeout,
                connect_timeout=timeout,
            )
            return  # –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        except TimedOut:
            if attempt < max_retries - 1:
                wait_time = (attempt + 1) * 2
                logger.warning(f"–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}), –∂–¥—É {wait_time}—Å...")
                await asyncio.sleep(wait_time)
                document.seek(0)
            else:
                logger.warning(f"–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫, –ø—Ä–æ–±—É—é –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ —Ñ–æ—Ç–æ...")
                # Fallback: –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ —Ñ–æ—Ç–æ
                document.seek(0)
                try:
                    await bot.send_photo(
                        chat_id=chat_id,
                        photo=document,
                        caption=caption,
                        read_timeout=timeout,
                        write_timeout=timeout,
                        connect_timeout=timeout,
                    )
                    return
                except Exception as photo_err:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ (fallback): {photo_err}")
                    raise
        except Exception as e:
            if attempt < max_retries - 1:
                wait_time = (attempt + 1) * 2
                logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}): {e}, –∂–¥—É {wait_time}—Å...")
                await asyncio.sleep(wait_time)
                document.seek(0)
            else:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫: {e}")
                # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –ø—Ä–æ–±—É–µ–º —Ñ–æ—Ç–æ
                document.seek(0)
                try:
                    await bot.send_photo(
                        chat_id=chat_id,
                        photo=document,
                        caption=caption,
                        read_timeout=timeout,
                        write_timeout=timeout,
                        connect_timeout=timeout,
                    )
                    return
                except Exception as photo_err:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ (fallback): {photo_err}")
                    raise


def _styles_keyboard() -> InlineKeyboardMarkup:
    rows: list[list[InlineKeyboardButton]] = []
    # –ö–Ω–æ–ø–∫–∏ KIE –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π
    
    # Imagen4 Ultra
    rows.append([
        InlineKeyboardButton("üöÄ Imagen4 Ultra", callback_data="pl_kie_test:google/imagen4-ultra"),
    ])
    
    # Flux-2 –º–æ–¥–µ–ª–∏
    rows.append([
        InlineKeyboardButton("‚ö° Flux Pro Img2Img", callback_data="pl_kie_test:flux-2/pro-image-to-image"),
        InlineKeyboardButton("‚ö° Flux Flex Img2Img", callback_data="pl_kie_test:flux-2/flex-image-to-image"),
    ])
    rows.append([
        InlineKeyboardButton("‚ö° Flux Flex T2I", callback_data="pl_kie_test:flux-2/flex-text-to-image"),
        InlineKeyboardButton("‚ö° Flux Pro T2I", callback_data="pl_kie_test:flux-2/pro-text-to-image"),
    ])
    
    # Ideogram V3 –º–æ–¥–µ–ª–∏
    rows.append([
        InlineKeyboardButton("üé® Ideogram V3 T2I", callback_data="pl_kie_test:ideogram/v3-text-to-image"),
        InlineKeyboardButton("‚úèÔ∏è Ideogram V3 Edit", callback_data="pl_kie_test:ideogram/v3-edit"),
    ])
    rows.append([
        InlineKeyboardButton("üîÑ Ideogram V3 Remix", callback_data="pl_kie_test:ideogram/v3-remix"),
    ])
    
    # Ideogram Character –º–æ–¥–µ–ª–∏
    rows.append([
        InlineKeyboardButton("üë§ Character", callback_data="pl_kie_test:ideogram/character"),
        InlineKeyboardButton("‚úèÔ∏è Char Edit", callback_data="pl_kie_test:ideogram/character-edit"),
    ])
    rows.append([
        InlineKeyboardButton("üîÑ Char Remix", callback_data="pl_kie_test:ideogram/character-remix"),
    ])
    
    # –°—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    rows.append([
        InlineKeyboardButton("üçå Nano Banana", callback_data="pl_kie_test:nano-banana-pro"),
        InlineKeyboardButton("üé® Seedream 4.5", callback_data="pl_kie_test:seedream/4.5-text-to-image"),
    ])
    
    # Astria LoRA –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    rows.append([
        InlineKeyboardButton("üéØ Astria LoRA (10 —Ñ–æ—Ç–æ)", callback_data="pl_astria_lora"),
    ])
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Astria (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è LoRA/FaceID)
    rows.append([
        InlineKeyboardButton("üåü Astria", callback_data="pl_astria_generate"),
    ])
    
    # –í—Ä–µ–º–µ–Ω–Ω–æ —É–±—Ä–∞–Ω—ã –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (—Å—Ç–∏–ª–∏, –ø–æ—Ö–æ–∂–µ—Å—Ç—å, –ø—Ä–æ–≤–∞–π–¥–µ—Ä, —Å—Ü–µ–Ω–∞, –∏ —Ç.–¥.)
    
    return InlineKeyboardMarkup(rows)


def _get_prompt_strength(settings, context: ContextTypes.DEFAULT_TYPE) -> float:
    v = context.user_data.get(USERDATA_PROMPT_STRENGTH)
    try:
        if v is not None:
            return max(0.1, min(0.95, float(v)))
    except Exception:
        pass
    return float(settings.prompt_strength)


async def restart_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)"""
    user_id = update.effective_user.id if update.effective_user else None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ ADMIN_ID –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    # –ü–æ–∫–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    logger = logging.getLogger("prismalab")
    logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /restart –≤—ã–∑–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
    
    await update.message.reply_text(
        "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞...\n\n"
        "–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã. –ó–∞–ø—É—Å—Ç–∏ –µ–≥–æ –∑–∞–Ω–æ–≤–æ –∫–æ–º–∞–Ω–¥–æ–π:\n"
        "`cd /Users/germanzukov/PrismaLab && python3 -m prismalab.bot > bot.log 2>&1 &`\n\n"
        "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞."
    )
    
    # –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è, –∑–∞—Ç–µ–º –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
    import asyncio
    await asyncio.sleep(2)
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
    import sys
    logger.info("–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–æ—Ç–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ /restart")
    sys.exit(0)


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    settings = load_settings()
    text = (
        f"–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ *{settings.app_name}*.\n\n"
        "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–æ—Ç–æ, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ 10 —Å—Ç–∏–ª–µ–π ‚Äî –∏ —è –≤–µ—Ä–Ω—É –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.\n\n"
        "–û—Ç–ø—Ä–∞–≤–ª—è–π –æ–±—ã—á–Ω—ã–º —Ñ–æ—Ç–æ ‚Äî –≤—Å—ë –æ–∫."
    )
    await update.message.reply_text(
        text,
        parse_mode="Markdown",
        reply_markup=_styles_keyboard(),
    )


async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not update.message or not update.message.photo:
        return

    mode = context.user_data.get(USERDATA_MODE) or "normal"
    logger.info(f"[Photo Handler] –†–µ–∂–∏–º: {mode}, user {update.effective_user.id}")
    photo = update.message.photo[-1]  # —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ
    if mode == "astria_faceid":
        ids = list(context.user_data.get(USERDATA_ASTRIA_FACEID_FILE_IDS, []))
        if len(ids) >= 1:
            await update.message.reply_text("–£–∂–µ –µ—Å—Ç—å —Ñ–æ—Ç–æ –¥–ª—è FaceID. –ñ–¥—É —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ç–æ¬ª.")
            return
        ids.append(photo.file_id)
        context.user_data[USERDATA_ASTRIA_FACEID_FILE_IDS] = ids
        await update.message.reply_text("–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –°–æ–∑–¥–∞—é FaceID tune (–æ–±—ã—á–Ω–æ 10‚Äì30 —Å–µ–∫—É–Ω–¥)‚Ä¶")
        # Lock —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ _start_astria_faceid
        context.application.create_task(_start_astria_faceid(context, update.effective_chat.id, update.effective_user.id))
        return
    elif mode == "astria_lora":
        logger.info(f"[LoRA Photo] –†–µ–∂–∏–º astria_lora –∞–∫—Ç–∏–≤–µ–Ω, –ø–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ –æ—Ç user {update.effective_user.id}")
        ids = list(context.user_data.get(USERDATA_ASTRIA_LORA_FILE_IDS, []))
        logger.info(f"[LoRA Photo] –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ: {len(ids)}/10")
        if len(ids) >= 10:
            await update.message.reply_text("–£–∂–µ –µ—Å—Ç—å 10 —Ñ–æ—Ç–æ –¥–ª—è LoRA. –ñ–¥—É —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ç–æ¬ª.")
            return
        ids.append(photo.file_id)
        context.user_data[USERDATA_ASTRIA_LORA_FILE_IDS] = ids
        count = len(ids)
        logger.info(f"[LoRA Photo] –î–æ–±–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ, —Ç–µ–ø–µ—Ä—å {count}/10")
        if count < 10:
            await update.message.reply_text(f"–§–æ—Ç–æ {count}/10 –ø–æ–ª—É—á–µ–Ω–æ. –û—Ç–ø—Ä–∞–≤—å –µ—â—ë {10 - count} —Ñ–æ—Ç–æ.")
        else:
            await update.message.reply_text("10 —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –°–æ–∑–¥–∞—é LoRA –º–æ–¥–µ–ª—å –Ω–∞ Flux 2 Pro (10‚Äì60 –º–∏–Ω—É—Ç, –∏–Ω–æ–≥–¥–∞ –¥–æ 2 —á–∞—Å–æ–≤)‚Ä¶")
            # Lock —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ _start_astria_lora, –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–¥–µ—Å—å
            context.application.create_task(_start_astria_lora(context, update.effective_chat.id, update.effective_user.id))
        return

    ids = list(context.user_data.get(USERDATA_PHOTO_FILE_IDS, []))
    if len(ids) >= 4:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —à–ª—ë—Ç –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –æ–Ω —Ö–æ—á–µ—Ç –ó–ê–ú–ï–ù–ò–¢–¨ –Ω–∞–±–æ—Ä.
        context.user_data[USERDATA_PHOTO_FILE_IDS] = [photo.file_id]
        context.user_data[USERDATA_USE_PERSONAL] = False
        await update.message.reply_text(
            "–§–æ—Ç–æ –∑–∞–º–µ–Ω–µ–Ω–æ (1/4). –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å.\n\n"
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å ‚Äî –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë 1‚Äì3 —Ñ–æ—Ç–æ —ç—Ç–æ–≥–æ –∂–µ —á–µ–ª–æ–≤–µ–∫–∞.",
            reply_markup=_styles_keyboard(),
        )
        return
    ids.append(photo.file_id)
    context.user_data[USERDATA_PHOTO_FILE_IDS] = ids
    context.user_data[USERDATA_USE_PERSONAL] = False
    await update.message.reply_text(
        f"–§–æ—Ç–æ {len(ids)}/4 –ø–æ–ª—É—á–∏–ª. –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å.\n\n"
        "–î–ª—è –ª—É—á—à–µ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ª–∏—Ü–∞ –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë 1‚Äì3 —Ñ–æ—Ç–æ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–µ —Ä–∞–∫—É—Ä—Å—ã).",
        parse_mode="Markdown",
        reply_markup=_styles_keyboard(),
    )


async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not update.message or not update.message.document:
        return
    doc = update.message.document
    if not (doc.mime_type or "").startswith("image/"):
        await update.message.reply_text("–ü—Ä–∏—à–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É (—Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º).")
        return

    mode = context.user_data.get(USERDATA_MODE) or "normal"
    if mode == "astria_faceid":
        ids = list(context.user_data.get(USERDATA_ASTRIA_FACEID_FILE_IDS, []))
        if len(ids) >= 1:
            await update.message.reply_text("–£–∂–µ –µ—Å—Ç—å —Ñ–æ—Ç–æ –¥–ª—è FaceID. –ñ–¥—É —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ç–æ¬ª.")
            return
        ids.append(doc.file_id)
        context.user_data[USERDATA_ASTRIA_FACEID_FILE_IDS] = ids
        await update.message.reply_text("–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –°–æ–∑–¥–∞—é FaceID tune (–æ–±—ã—á–Ω–æ 10‚Äì30 —Å–µ–∫—É–Ω–¥)‚Ä¶")
        # Lock —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ _start_astria_faceid
        context.application.create_task(_start_astria_faceid(context, update.effective_chat.id, update.effective_user.id))
        return
    elif mode == "astria_lora":
        ids = list(context.user_data.get(USERDATA_ASTRIA_LORA_FILE_IDS, []))
        if len(ids) >= 10:
            await update.message.reply_text("–£–∂–µ –µ—Å—Ç—å 10 —Ñ–æ—Ç–æ –¥–ª—è LoRA. –ñ–¥—É —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–°–±—Ä–æ—à–∏—Ç—å —Ñ–æ—Ç–æ¬ª.")
            return
        ids.append(doc.file_id)
        context.user_data[USERDATA_ASTRIA_LORA_FILE_IDS] = ids
        count = len(ids)
        if count < 10:
            await update.message.reply_text(f"–§–æ—Ç–æ {count}/10 –ø–æ–ª—É—á–µ–Ω–æ. –û—Ç–ø—Ä–∞–≤—å –µ—â—ë {10 - count} —Ñ–æ—Ç–æ.")
        else:
            await update.message.reply_text("10 —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –°–æ–∑–¥–∞—é LoRA –º–æ–¥–µ–ª—å (10‚Äì30 –º–∏–Ω—É—Ç)‚Ä¶")
            # Lock —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ _start_astria_lora, –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–¥–µ—Å—å
            context.application.create_task(_start_astria_lora(context, update.effective_chat.id, update.effective_user.id))
        return

    ids = list(context.user_data.get(USERDATA_PHOTO_FILE_IDS, []))
    if len(ids) >= 4:
        context.user_data[USERDATA_PHOTO_FILE_IDS] = [doc.file_id]
        context.user_data[USERDATA_USE_PERSONAL] = False
        await update.message.reply_text(
            "–§–æ—Ç–æ –∑–∞–º–µ–Ω–µ–Ω–æ (1/4). –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å.\n\n"
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å ‚Äî –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë 1‚Äì3 —Ñ–æ—Ç–æ —ç—Ç–æ–≥–æ –∂–µ —á–µ–ª–æ–≤–µ–∫–∞.",
            reply_markup=_styles_keyboard(),
        )
        return
    ids.append(doc.file_id)
    context.user_data[USERDATA_PHOTO_FILE_IDS] = ids
    context.user_data[USERDATA_USE_PERSONAL] = False
    await update.message.reply_text(
        f"–§–∞–π–ª-–∫–∞—Ä—Ç–∏–Ω–∫—É {len(ids)}/4 –ø–æ–ª—É—á–∏–ª (–±–µ–∑ —Å–∂–∞—Ç–∏—è). –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å –µ—â—ë —Ñ–æ—Ç–æ:",
        reply_markup=_styles_keyboard(),
    )


async def handle_prompt_strength_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query:
        return
    await query.answer()

    settings = load_settings()
    action = (query.data or "").split(":", 1)[1] if ":" in (query.data or "") else ""
    if action == "noop":
        return

    cur = _get_prompt_strength(settings, context)
    step = 0.05
    if action == "down":
        # ‚Äú–ü–æ—Ö–æ–∂–µ—Å—Ç—å‚Äù = –º–µ–Ω—å—à–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ => —É–º–µ–Ω—å—à–∞–µ–º prompt_strength
        cur = max(0.1, cur - step)
    elif action == "up":
        cur = min(0.95, cur + step)

    context.user_data[USERDATA_PROMPT_STRENGTH] = cur
    try:
        await query.edit_message_reply_markup(
            reply_markup=_styles_keyboard()
        )
    except Exception:
        pass


async def handle_gender_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query:
        return
    await query.answer()

    data = query.data or ""
    action = data.split(":", 1)[1] if ":" in data else ""
    if action == "male":
        context.user_data[USERDATA_SUBJECT_GENDER] = "male"
    elif action == "female":
        context.user_data[USERDATA_SUBJECT_GENDER] = "female"
    else:
        context.user_data.pop(USERDATA_SUBJECT_GENDER, None)

    settings = load_settings()
    ps = _get_prompt_strength(settings, context)
    try:
        await query.edit_message_reply_markup(
            reply_markup=_styles_keyboard()
        )
    except Exception:
        pass


async def handle_personal_toggle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query:
        return
    await query.answer()
    uid = int(query.from_user.id) if query.from_user else 0
    profile = store.get_user(uid) if uid else None
    has_personal = bool(profile and profile.personal_model_version and profile.personal_trigger_word)
    if not has_personal:
        await query.message.reply_text("–£ —Ç–µ–±—è –µ—â—ë –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏. –ù–∞–∂–º–∏ ¬´10 —Ñ–æ—Ç–æ¬ª.")
        return

    enabled = _is_personal_enabled(context)
    context.user_data[USERDATA_USE_PERSONAL] = (not enabled)

    settings = load_settings()
    ps = _get_prompt_strength(settings, context)
    try:
        await query.edit_message_reply_markup(
            reply_markup=_styles_keyboard()
        )
    except Exception:
        pass


async def handle_reset_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    import logging
    logger = logging.getLogger("prismalab")
    
    query = update.callback_query
    if not query:
        logger.warning("handle_reset_callback –≤—ã–∑–≤–∞–Ω –±–µ–∑ query")
        return
    
    try:
        await query.answer()
        user_id = update.effective_user.id
        logger.info(f"–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è user {user_id}")
        
        # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ user_data
        context.user_data.pop(USERDATA_PHOTO_FILE_IDS, None)
        context.user_data.pop(USERDATA_ASTRIA_FACEID_FILE_IDS, None)
        context.user_data.pop(USERDATA_ASTRIA_LORA_FILE_IDS, None)
        context.user_data.pop(USERDATA_NANO_BANANA_FILE_IDS, None)
        context.user_data.pop(USERDATA_MODE, None)
        context.user_data.pop(USERDATA_PROMPT_STRENGTH, None)
        context.user_data.pop(USERDATA_SUBJECT_GENDER, None)
        context.user_data.pop(USERDATA_USE_PERSONAL, None)
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã (storage) - –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
        try:
            store.clear_user_data(user_id=user_id)
            logger.info(f"–î–∞–Ω–Ω—ã–µ –∏–∑ storage –æ—á–∏—â–µ–Ω—ã –¥–ª—è user {user_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ storage –¥–ª—è user {user_id}: {e}", exc_info=True)
        
        # –°–±—Ä–æ—Å —Ñ–æ—Ç–æ –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç ‚Äú—Ä–∞–±–æ—Ç–∞–µ–º –ø–æ –Ω–æ–≤—ã–º —Ñ–æ—Ç–æ‚Äù, –∞ –Ω–µ –ø–æ —Å—Ç–∞—Ä–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏
        context.user_data[USERDATA_USE_PERSONAL] = False
        await query.edit_message_text("‚úÖ –í—Å–µ —Ñ–æ—Ç–æ –∏ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –û—Ç–ø—Ä–∞–≤—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ.")
        logger.info(f"–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è user {user_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_reset_callback: {e}", exc_info=True)
        try:
            await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ", show_alert=True)
        except:
            pass


async def handle_astria_faceid_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query:
        return
    await query.answer()
    settings = load_settings()
    if not settings.astria_api_key:
        await query.message.reply_text("Astria –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ù—É–∂–µ–Ω PRISMALAB_ASTRIA_API_KEY.")
        return
    context.user_data[USERDATA_MODE] = "astria_faceid"
    context.user_data[USERDATA_ASTRIA_FACEID_FILE_IDS] = []
    await query.message.reply_text(
        "üì∏ –†–µ–∂–∏–º ¬´FaceID (1 —Ñ–æ—Ç–æ)¬ª.\n\n"
        "–ü—Ä–∏—à–ª–∏ 1 —Ñ–æ—Ç–æ (–ª—É—á—à–µ —Å–µ–ª—Ñ–∏/–ø–æ—Ä—Ç—Ä–µ—Ç, –ª–∏—Ü–æ –∫—Ä—É–ø–Ω–æ).\n"
        "–Ø —Å–æ–∑–¥–∞–º FaceID tune (~10‚Äì30 —Å–µ–∫—É–Ω–¥), –∏ –ø–æ—Ç–æ–º —Å–º–æ–∂–µ—à—å –≥–µ–Ω–µ—Ä–∏—Ç—å —Å—Ü–µ–Ω—ã —Å —Ç–≤–æ–∏–º –ª–∏—Ü–æ–º."
    )


async def handle_astria_lora_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query:
        return
    await query.answer()
    settings = load_settings()
    if not settings.astria_api_key:
        await query.message.reply_text("Astria –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ù—É–∂–µ–Ω PRISMALAB_ASTRIA_API_KEY.")
        return
    context.user_data[USERDATA_MODE] = "astria_lora"
    context.user_data[USERDATA_ASTRIA_LORA_FILE_IDS] = []
    logger.info(f"[LoRA] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º astria_lora –¥–ª—è user {query.from_user.id}")
    await query.message.reply_text(
        "üéØ –†–µ–∂–∏–º ¬´LoRA (10 —Ñ–æ—Ç–æ)¬ª.\n\n"
        "–ü—Ä–∏—à–ª–∏ 10 —Ñ–æ—Ç–æ –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ (—Ä–∞–∑–Ω—ã–µ —Ä–∞–∫—É—Ä—Å—ã, –ø–æ–∑—ã, —Ñ–æ–Ω).\n"
        "–Ø —Å–æ–∑–¥–∞–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é LoRA –º–æ–¥–µ–ª—å –Ω–∞ Flux 2 Pro (~10‚Äì60 –º–∏–Ω—É—Ç, –∏–Ω–æ–≥–¥–∞ –¥–æ 2 —á–∞—Å–æ–≤), –∏ –ø–æ—Ç–æ–º —Å–º–æ–∂–µ—à—å –≥–µ–Ω–µ—Ä–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—Ü–µ–Ω —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º.\n\n"
        "–°–æ–≤–µ—Ç—ã:\n"
        "‚Ä¢ –†–∞–∑–Ω—ã–µ —Ä–∞–∫—É—Ä—Å—ã –∏ –ø–æ–∑—ã\n"
        "‚Ä¢ –†–∞–∑–Ω—ã–π —Ñ–æ–Ω –∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ\n"
        "‚Ä¢ –ü–æ—Ä—Ç—Ä–µ—Ç—ã –∏ —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω—ã–π —Ä–æ—Å—Ç\n"
        "‚Ä¢ –ë–µ–∑ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π –Ω–∞ —Ñ–æ—Ç–æ\n\n"
        "–û—Ç–ø—Ä–∞–≤–ª—è–π —Ñ–æ—Ç–æ –ø–æ –æ–¥–Ω–æ–º—É. –Ø –±—É–¥—É —Å—á–∏—Ç–∞—Ç—å: 1/10, 2/10, –∏ —Ç.–¥."
    )


# –§—É–Ω–∫—Ü–∏—è handle_nano_banana_multi_callback —É–¥–∞–ª–µ–Ω–∞ - –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
# Replicate train10 (_start_train10) —É–¥–∞–ª—ë–Ω


async def _start_astria_faceid(context: ContextTypes.DEFAULT_TYPE, chat_id: int, user_id: int) -> None:
    logger.info(f"[FACEID] ========== –ù–ê–ß–ê–õ–û —Å–æ–∑–¥–∞–Ω–∏—è FaceID –¥–ª—è user {user_id} ==========")
    # –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
    if context.user_data.get(USERDATA_JOB_LOCK):
        logger.warning(f"[FACEID] ‚ùå –£–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥—Ä—É–≥–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è user {user_id}")
        return
    context.user_data[USERDATA_JOB_LOCK] = True
    logger.info(f"[FACEID] ‚úÖ Lock —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è user {user_id}")
    
    try:
        logger.info(f"[FACEID] –ó–∞–≥—Ä—É–∂–∞—é settings...")
        settings = load_settings()
        logger.info(f"[FACEID] Settings –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è—é API –∫–ª—é—á...")
        if not settings.astria_api_key:
            logger.error(f"[FACEID] ‚ùå Astria API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            await context.bot.send_message(chat_id=chat_id, text="Astria –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ù—É–∂–µ–Ω PRISMALAB_ASTRIA_API_KEY.")
            return
        
        logger.info(f"[FACEID] –ü–æ–ª—É—á–∞—é file_ids –∏–∑ user_data...")
        file_ids = list(context.user_data.get(USERDATA_ASTRIA_FACEID_FILE_IDS, []))
        logger.info(f"[FACEID] –ù–∞–π–¥–µ–Ω–æ file_ids: {len(file_ids)}")
        if not file_ids:
            logger.warning(f"[FACEID] ‚ùå –ù–µ—Ç file_ids –¥–ª—è user {user_id}")
            await context.bot.send_message(chat_id=chat_id, text="–ù—É–∂–Ω–æ —Ñ–æ—Ç–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è FaceID.")
            return
        
        # –±–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–∞–π–º–∞—É—Ç–æ–≤)
        logger.info(f"[FACEID] –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ –¥–ª—è user {user_id}, file_id: {file_ids[0][:20]}...")
        image_bytes = await _safe_get_file_bytes(context.bot, file_ids[0])
        logger.info(f"–§–æ—Ç–æ —Å–∫–∞—á–∞–Ω–æ, —Ä–∞–∑–º–µ—Ä: {len(image_bytes)} –±–∞–π—Ç, –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é...")
        # –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ (–∫–∞–∫ –¥–ª—è Photomaker) - —Ñ—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–µ—Ç bytes, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç bytes
        image_bytes = _prepare_image_for_photomaker(image_bytes)
        logger.info(f"–§–æ—Ç–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ, —Ä–∞–∑–º–µ—Ä: {len(image_bytes)} –±–∞–π—Ç")
        try:
            await context.bot.send_message(chat_id=chat_id, text="–°–æ–∑–¥–∞—é FaceID tune‚Ä¶", read_timeout=20, write_timeout=20, connect_timeout=20)
        except TimedOut:
            logger.warning("–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è '–°–æ–∑–¥–∞—é FaceID tune', –ø—Ä–æ–¥–æ–ª–∂–∞—é...")
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è '–°–æ–∑–¥–∞—é FaceID tune': {e}, –ø—Ä–æ–¥–æ–ª–∂–∞—é...")
        result: AstriaTuneResult = await astria_create_faceid_tune_and_wait(
            api_key=settings.astria_api_key,
            name="person",  # Astria —Ç—Ä–µ–±—É–µ—Ç –∫–ª–∞—Å—Å –¥–ª—è –ª–∏—Ü: man, woman, person, boy, girl
            title=f"FaceID user {user_id}",  # –ë–µ–∑ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
            image_bytes=image_bytes,
            base_tune_id=settings.astria_tune_id,  # –±–∞–∑–æ–≤—ã–π tune (–Ω–∞–ø—Ä–∏–º–µ—Ä, Flux)
            max_seconds=120,
        )
        store.set_astria_tune(user_id=user_id, tune_id=result.tune_id)
        context.user_data[USERDATA_MODE] = "normal"
        context.user_data.pop(USERDATA_ASTRIA_FACEID_FILE_IDS, None)
        await context.bot.send_message(
            chat_id=chat_id,
            text="‚úÖ –ì–æ—Ç–æ–≤–æ! FaceID tune —Å–æ–∑–¥–∞–Ω.\n"
            "–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–π —Å—Ç–∏–ª—å ‚Äî —è –±—É–¥—É –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω—ã —Å —Ç–≤–æ–∏–º –ª–∏—Ü–æ–º —á–µ—Ä–µ–∑ Astria.",
            reply_markup=_styles_keyboard(),
        )
    except AstriaError as e:
        error_msg = str(e)
        logger.error(f"[FACEID] ‚ùå AstriaError: {error_msg}", exc_info=True)
        try:
            await context.bot.send_message(chat_id=chat_id, text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ FaceID: {error_msg}")
        except:
            pass
    except Exception as e:
        error_type = type(e).__name__
        error_msg = str(e)
        logger.error(f"[FACEID] ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {error_type}: {error_msg}", exc_info=True)
        try:
            await context.bot.send_message(chat_id=chat_id, text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ FaceID: {error_msg[:200]}")
        except:
            pass
    finally:
        logger.info(f"[FACEID] –°–±—Ä–∞—Å—ã–≤–∞—é lock –¥–ª—è user {user_id}")
        context.user_data[USERDATA_JOB_LOCK] = False
        logger.info(f"[FACEID] ========== –ö–û–ù–ï–¶ —Å–æ–∑–¥–∞–Ω–∏—è FaceID –¥–ª—è user {user_id} ==========")


async def _start_astria_lora(context: ContextTypes.DEFAULT_TYPE, chat_id: int, user_id: int) -> None:
    """–°–æ–∑–¥–∞—ë—Ç LoRA tune –∏–∑ 10 —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ Astria API."""
    logger.info(f"[LoRA] ========== –ù–ê–ß–ê–õ–û —Å–æ–∑–¥–∞–Ω–∏—è LoRA –¥–ª—è user {user_id} ==========")
    # –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
    if context.user_data.get(USERDATA_JOB_LOCK):
        logger.warning(f"[LoRA] ‚ùå Lock —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è user {user_id}, –ø—Ä–æ–ø—É—Å–∫–∞—é")
        return
    context.user_data[USERDATA_JOB_LOCK] = True
    
    try:
        settings = load_settings()
        logger.info(f"[LoRA] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è—é API –∫–ª—é—á...")
        if not settings.astria_api_key:
            logger.error(f"[LoRA] ‚ùå –ù–µ—Ç API –∫–ª—é—á–∞ Astria")
            await context.bot.send_message(chat_id=chat_id, text="Astria –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ù—É–∂–µ–Ω PRISMALAB_ASTRIA_API_KEY.")
            return
        logger.info(f"[LoRA] API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω (–¥–ª–∏–Ω–∞: {len(settings.astria_api_key)})")
        
        file_ids = list(context.user_data.get(USERDATA_ASTRIA_LORA_FILE_IDS, []))
        logger.info(f"[LoRA] –ü–æ–ª—É—á–µ–Ω–æ file_ids: {len(file_ids)}")
        if len(file_ids) < 10:
            logger.warning(f"[LoRA] ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–æ—Ç–æ: {len(file_ids)}/10")
            await context.bot.send_message(
                chat_id=chat_id,
                text=f"–ù—É–∂–Ω–æ 10 —Ñ–æ—Ç–æ. –°–µ–π—á–∞—Å {len(file_ids)}/10. –û—Ç–ø—Ä–∞–≤—å –µ—â—ë {10 - len(file_ids)} —Ñ–æ—Ç–æ."
            )
            return
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª –ø–æ –ø–µ—Ä–≤–æ–º—É —Ñ–æ—Ç–æ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
        gender = context.user_data.get(USERDATA_SUBJECT_GENDER) or "auto"
        name = "man" if gender == "male" else "woman" if gender == "female" else "person"
        
        # –°–∫–∞—á–∏–≤–∞–µ–º –≤—Å–µ 10 —Ñ–æ—Ç–æ (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–∞–π–º–∞—É—Ç–æ–≤)
        image_bytes_list = []
        await context.bot.send_message(chat_id=chat_id, text="–°–∫–∞—á–∏–≤–∞—é 10 —Ñ–æ—Ç–æ‚Ä¶")
        for idx, fid in enumerate(file_ids, 1):
            try:
                image_bytes = await _safe_get_file_bytes(context.bot, fid)
                # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
                image_bytes = _prepare_image_for_photomaker(image_bytes)
                image_bytes_list.append(image_bytes)
                if idx % 3 == 0:  # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 3 —Ñ–æ—Ç–æ
                    await context.bot.send_message(chat_id=chat_id, text=f"–°–∫–∞—á–∞–Ω–æ {idx}/10 —Ñ–æ—Ç–æ‚Ä¶")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–æ—Ç–æ {idx}/10: {e}")
                await context.bot.send_message(chat_id=chat_id, text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–æ—Ç–æ {idx}/10. –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∑–∞–Ω–æ–≤–æ.")
                raise
        
        await context.bot.send_message(chat_id=chat_id, text="–°–æ–∑–¥–∞—é LoRA tune –Ω–∞ Flux1.dev‚Ä¶\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10‚Äì60 –º–∏–Ω—É—Ç (–∏–Ω–æ–≥–¥–∞ –¥–æ 2 —á–∞—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Astria). –Ø –Ω–∞–ø–∏—à—É, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ.")
        
        logger.info(f"[LoRA] –ù–∞—á–∏–Ω–∞—é —Å–æ–∑–¥–∞–Ω–∏–µ LoRA tune —á–µ—Ä–µ–∑ Astria API...")
        from prismalab.astria_client import create_lora_tune_and_wait
        
        logger.info(f"[LoRA] –í—ã–∑—ã–≤–∞—é create_lora_tune_and_wait —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: name={name}, base_tune_id=1504944, preset=flux-lora-portrait")
        result = await create_lora_tune_and_wait(
            api_key=settings.astria_api_key,
            name=name,
            title=f"LoRA user {user_id}",
            image_bytes_list=image_bytes_list,
            base_tune_id="1504944",  # Flux1.dev –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è LoRA)
            preset="flux-lora-portrait",  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ª—é–¥–µ–π
            max_seconds=7200,  # –î–æ 2 —á–∞—Å–æ–≤ –Ω–∞ training (—É–≤–µ–ª–∏—á–µ–Ω–æ —Å 1 —á–∞—Å–∞)
            poll_seconds=15.0,
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∫–∞–∫ LoRA
        model_type = result.raw.get("model_type") or "unknown"
        if model_type.lower() != "lora":
            logger.error(f"‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: Astria —Å–æ–∑–¥–∞–ª tune {result.tune_id} –∫–∞–∫ '{model_type}', –∞ –Ω–µ –∫–∞–∫ 'lora'!")
            await context.bot.send_message(
                chat_id=chat_id,
                text=f"‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞ –∫–∞–∫ '{model_type}' –≤–º–µ—Å—Ç–æ 'lora'. –ü–æ–ø—Ä–æ–±—É–π —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ."
            )
            return
        
        store.set_astria_lora_tune(user_id=user_id, tune_id=result.tune_id)
        context.user_data[USERDATA_MODE] = "normal"
        context.user_data.pop(USERDATA_ASTRIA_LORA_FILE_IDS, None)
        
        logger.info(f"‚úÖ LoRA {result.tune_id} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (model_type='{model_type}')")
        await context.bot.send_message(
            chat_id=chat_id,
            text="‚úÖ –ì–æ—Ç–æ–≤–æ! LoRA –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ Flux1.dev.\n"
            f"ID –º–æ–¥–µ–ª–∏: {result.tune_id}\n"
            "–¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´üåü Astria¬ª ‚Äî —è –±—É–¥—É –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω—ã —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º —á–µ—Ä–µ–∑ Astria LoRA.",
            reply_markup=_styles_keyboard(),
        )
    except AstriaError as e:
        error_msg = str(e)
        logger.error("Astria LoRA error: %s", e, exc_info=True)
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if "HTTP 401" in error_msg or "401" in error_msg:
            await context.bot.send_message(chat_id=chat_id, text="‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Astria. –ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á –≤ .env —Ñ–∞–π–ª–µ.")
        elif "HTTP 422" in error_msg or "422" in error_msg:
            await context.bot.send_message(chat_id=chat_id, text=f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Astria: {error_msg[:200]}")
        elif "HTTP 400" in error_msg or "400" in error_msg:
            await context.bot.send_message(chat_id=chat_id, text=f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Astria: {error_msg[:200]}")
        else:
            await context.bot.send_message(chat_id=chat_id, text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ LoRA: {error_msg[:300]}")
    except Exception as e:
        error_type = type(e).__name__
        error_msg = str(e)
        import traceback
        tb_str = traceback.format_exc()
        logger.error("Astria LoRA error: %s: %s\n%s", error_type, error_msg, tb_str)
        await context.bot.send_message(
            chat_id=chat_id,
            text=f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ LoRA.\n\n–¢–∏–ø: {error_type}\n–û—à–∏–±–∫–∞: {error_msg[:300]}\n\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞."
        )
    finally:
        context.user_data[USERDATA_JOB_LOCK] = False


async def _run_style_job(
    *,
    bot,
    chat_id: int,
    photo_file_ids: list[str],
    style_id: str,
    settings,
    status_message_id: int,
    prompt_strength: float,
    user_id: int,
    subject_gender: str | None,
    use_personal_requested: bool,
    test_prompt: str | None = None,
    context: ContextTypes.DEFAULT_TYPE | None = None,
) -> None:
    try:
        use_test_prompt = test_prompt is not None
        if use_test_prompt:
            from prismalab.styles import StylePreset
            style = StylePreset(
                id="test",
                title="–¢–µ—Å—Ç",
                prompt="",
                negative_prompt="",
            )
        else:
            style = get_style(style_id)
            if not style:
                await bot.edit_message_text(chat_id=chat_id, message_id=status_message_id, text="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∏–ª—å.")
                return

        await bot.send_chat_action(chat_id=chat_id, action=ChatAction.TYPING)
        refs: list[bytes] = []
        selected_ids = list(photo_file_ids[-4:])
        for fid in selected_ids:
            ref_bytes = await _safe_get_file_bytes(bot, fid)
            refs.append(ref_bytes)

        user_profile = store.get_user(user_id)
        needs_photo = not (user_profile and (user_profile.astria_lora_tune_id or user_profile.astria_tune_id))
        if user_profile and (user_profile.astria_lora_tune_id or user_profile.astria_tune_id):
            logger.info(f"[ASTRIA] LoRA/FaceID –Ω–∞–π–¥–µ–Ω, —Ñ–æ—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
        if not refs and needs_photo:
            await bot.edit_message_text(chat_id=chat_id, message_id=status_message_id, text="–ù–µ –Ω–∞—à—ë–ª —Ñ–æ—Ç–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
            return

        primary_ref = refs[-1] if refs else None
        profile_for_keyboard = store.get_user(user_id)
        has_personal_model = bool(profile_for_keyboard and profile_for_keyboard.personal_model_version and profile_for_keyboard.personal_trigger_word)
        personal_enabled = bool(has_personal_model and use_personal_requested)

        # –¢–æ–ª—å–∫–æ Astria (Replicate —É–¥–∞–ª—ë–Ω)
        if True:
            if not settings.astria_api_key:
                await bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=status_message_id,
                    text="Astria –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ù—É–∂–µ–Ω PRISMALAB_ASTRIA_API_KEY.",
                )
                return
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è FaceID –∏–ª–∏ LoRA tune
            user_profile = store.get_user(user_id)
            astria_tune_id = user_profile.astria_tune_id if user_profile else None
            astria_lora_tune_id = user_profile.astria_lora_tune_id if user_profile else None
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π tune –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç LoRA, –µ—Å–ª–∏ –µ—Å—Ç—å)
            use_lora = astria_lora_tune_id is not None
            active_tune_id = astria_lora_tune_id if use_lora else astria_tune_id
            logger.info(f"[ASTRIA Generate] astria_lora_tune_id={astria_lora_tune_id}, astria_tune_id={astria_tune_id}, use_lora={use_lora}, active_tune_id={active_tune_id}")
            logger.info(f"[ASTRIA Generate] base_model –±—É–¥–µ—Ç Flux1.dev (1504944) –¥–ª—è LoRA" if use_lora else f"[ASTRIA Generate] base_model –±—É–¥–µ—Ç Realistic Vision (690204) –¥–ª—è FaceID")
            
            if not active_tune_id:
                await bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=status_message_id,
                    text="‚ùå –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Astria –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—Ç—å FaceID –∏–ª–∏ LoRA tune.\n\n"
                    "‚Ä¢ üì∏ FaceID (1 —Ñ–æ—Ç–æ) - –±—ã—Å—Ç—Ä–æ, –¥–ª—è –æ–¥–Ω–æ–π —Å—Ü–µ–Ω—ã\n"
                    "‚Ä¢ üéØ LoRA (10 —Ñ–æ—Ç–æ) - –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å—Ü–µ–Ω",
                )
                return
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: FaceID –∏–ª–∏ LoRA
            subj = _instantid_subject(subject_gender)
            
            if use_lora:
                # LoRA –≥–µ–Ω–µ—Ä–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º <lora:{tune_id}:strength> –≤ –ø—Ä–æ–º–ø—Ç–µ
                # Inference –Ω–∞ –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏ Flux1.dev (1504944)
                lora_weight = 1.1 # –¢–µ—Å—Ç: —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –≤–µ—Å –¥–ª—è LoRA (–±—ã–ª–æ: 1.0)
                
                # –ü—Ä–æ–º–ø—Ç –¥–ª—è Astria LoRA
                # –í–ê–ñ–ù–û: Astria —Ç—Ä–µ–±—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ "ohwx person" –≤ –ø—Ä–æ–º–ø—Ç–µ –¥–ª—è LoRA
                english_prompt = """IDENTICAL FACE AND FEATURES from reference photo, same skin tone, ultra high detail face. A cyberpunk-inspired waist-up shot in dark urban alley, woman leaning against brick wall. Vibrant pink and blue neon signs from above cast electric colored light across her face and torso. She wears a black leather jacket, hands in pockets. The contrasting neon colors create dramatic split-toning on her skin - magenta on one side, cyan on the other. Wet pavement reflects the lights below. Her direct, fearless gaze at camera, modern urban warrior vibe with hard-edged dramatic lighting"""
                text = (
                    f"<lora:{active_tune_id}:{lora_weight}> "
                    f"ohwx person, {english_prompt}"
                ).strip()
                neg = "blurry, low quality, deformed face, bad anatomy, cartoon, cgi, plastic skin, overly smooth skin"
                
                # –î–ª—è LoRA –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å Flux1.dev (1504944) - —Ç–∞ –∂–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å LoRA
                base_model_tune_id = "1504944"  # Flux1.dev –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
                logger.info(f"[ASTRIA LoRA] –ò—Å–ø–æ–ª—å–∑—É—é –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å Flux1.dev (1504944) –¥–ª—è inference —Å LoRA tune_id={active_tune_id}")
            else:
                # FaceID –≥–µ–Ω–µ—Ä–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º <faceid:{tune_id}:strength> –≤ –ø—Ä–æ–º–ø—Ç–µ
                # Inference –Ω–∞ –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏ Realistic Vision V5.1 (690204)
                # –ï–¥–∏–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–æ —Å–∞–¥)
                faceid_weight = 1.0  # Preset "MAX FACE": –¥–µ—Ñ–æ–ª—Ç 1.0 –¥–ª—è —É–ø–æ—Ä–∞ –≤ –ª–∏—Ü–æ
                
                # –ü—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, FaceID —Ç–µ–≥ –≤ –Ω–∞—á–∞–ª–µ (–∫–∞–∫ –≤ –≥–∞–ª–µ—Ä–µ–µ Astria)
                # –ü—Ä–æ–º–ø—Ç –ø—Ä–æ —Å–º–µ—é—â—É—é—Å—è –¥–µ–≤—É—à–∫—É –¥–ª—è Astria FaceID —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å
                english_prompt = (
                    "ultra realistic photograph, not illustration, not painting, not digital art, real photo, "
                    "same reference female character, candid laugh, head turned left, eyes squinting, looking away from camera, "
                    "tropical greenery background, golden hour, realistic photo, 35mm, shallow depth of field, "
                    "identity preserved, natural expression change, no face morphing, no distortion, correct anatomy, "
                    "no extra fingers, no text, natural skin pores, authentic photography, documentary style, candid photo, "
                    "professional photography, photorealistic, high detail, no CGI, no 3D render, no digital painting, no illustration style"
                )
                
                text = (
                    f"<faceid:{active_tune_id}:{faceid_weight}> "
                    f"{english_prompt}"
                ).strip()
                
                # –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º Astria
                neg = (
                    "blurry, low quality, deformed face, bad anatomy, cartoon, cgi, plastic skin, overly smooth skin"
                )
                
                # –î–ª—è FaceID –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å Realistic Vision V5.1 (690204)
                base_model_tune_id = settings.astria_tune_id  # 690204 - Realistic Vision V5.1 –∏–∑ –≥–∞–ª–µ—Ä–µ–∏

            # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            tune_type = "LoRA" if use_lora else "FaceID"
            logger.info(f"Astria {tune_type} –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–∏–ª—è {style.id} (–ø–æ–ª–Ω—ã–π, –¥–ª–∏–Ω–∞ {len(text)}): {text}")
            if use_lora:
                logger.info(f"Astria –ø—Ä–æ–º–ø—Ç - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–≥–æ–≤ LoRA: {text.count('<lora:')}")
            else:
                logger.info(f"Astria –ø—Ä–æ–º–ø—Ç - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–≥–æ–≤ FaceID: {text.count('<faceid:')}")
            
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text=f"–ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å—Ü–µ–Ω—É –≤ Astria: ¬´{style.title}¬ª‚Ä¶\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 —Å–µ–∫—É–Ω–¥.",
            )
            # text-to-image: input_image_bytes=None, denoising_strength –Ω–µ –Ω—É–∂–µ–Ω
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Å—Ü–µ–Ω
            # –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º style="Photographic" - –æ–Ω –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å–æ —Å—Ç–∏–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # –î–ª—è –≤–∏–Ω—Ç–∞–∂–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º color_grading –∏ film_grain
            import secrets
            random_seed = secrets.randbelow(2**32)  # 0 to 2^32-1 –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            
            # –î–ª—è –≤–∏–Ω—Ç–∞–∂–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—é, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –Ω–µ—Ç
            use_color_grading = None
            use_film_grain = False
            if style_id in {"vintage_film", "noir", "nyc_70s"}:
                use_color_grading = "Film Portra"
                use_film_grain = True
            
            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            if use_lora:
                # –î–ª—è LoRA (Flux): –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Flux –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç negative_prompt –∏ weighted prompts
                # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ (–º–µ–Ω—å—à–µ "—Ä–∏—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏")
                use_cfg_scale = 3.0  # –ï—â—ë —É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                use_steps = 40  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                
                # –î–ª—è LoRA –Ω–∞ Flux1.dev (1504944) –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
                use_face_correct = True  # –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏—Ü–∞
                use_face_swap = True  # –î–ª—è –ª—É—á—à–µ–≥–æ —Å—Ö–æ–¥—Å—Ç–≤–∞
                use_seed = random_seed  # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è Flux1.dev
                logger.info(f"[ASTRIA] LoRA –Ω–∞ Flux1.dev: –≤–∫–ª—é—á–∞—é face_correct, face_swap, seed")
                
                # –û—Ç–∫–ª—é—á–∞–µ–º inpaint_faces –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–º–æ–∂–µ—Ç –Ω–µ–º–Ω–æ–≥–æ —É—Ö—É–¥—à–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—Ü–∞)
                use_inpaint_faces = False  # –û—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                logger.info(f"[ASTRIA] LoRA: use_inpaint_faces={use_inpaint_faces} (–æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏)")
                super_resolution = True  # –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
                # –î–ª—è Flux negative_prompt –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                neg = None  # Flux –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç negative_prompt
            else:
                # Preset "MAX FACE" –¥–ª—è FaceID (—É–ø–æ—Ä –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –ª–∏—Ü–∞)
                # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ: cfg_scale=3, face_correct=true, face_swap=true
                # –£–ª—É—á—à–∞—é—Ç –ª–∏—Ü–æ: super_resolution=true
                # inpaint_faces –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è FaceID (—Ç–æ–ª—å–∫–æ –¥–ª—è LoRA)
                use_seed = random_seed  # –î–ª—è FaceID seed –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                if use_test_prompt:
                    # Preset "MAX FACE" –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
                    use_cfg_scale = 3.0
                    use_steps = 40  # 35-45 –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞ –ª–∏—Ü–∞
                else:
                    # Preset "MAX FACE" –¥–ª—è FaceID: cfg_scale=3 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                    use_cfg_scale = 3.0
                    # Steps 35-45 –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞ –ª–∏—Ü–∞ (–ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º)
                    use_steps = min(settings.astria_steps, 45) if settings.astria_steps else 40
                    if use_steps < 35:
                        use_steps = 35  # –ú–∏–Ω–∏–º—É–º 35 –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏—Ü–∞
                
                # Preset "MAX FACE": –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                use_face_correct = True  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è FaceID
                use_face_swap = True  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è FaceID
                # super_resolution=true –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —É–ª—É—á—à–∞–µ—Ç –ª–∏—Ü–æ
                super_resolution = True
                # inpaint_faces –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è FaceID (Astria –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 422)
                # –î–ª—è full-body/long-shot –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ LoRA —Å inpaint_faces
                use_inpaint_faces = None
                logger.info(f"[ASTRIA] FaceID MAX FACE: cfg_scale={use_cfg_scale}, steps={use_steps}, inpaint_faces={use_inpaint_faces} (None - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)")
            # –ö–†–ò–¢–ò–ß–ù–û: –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Astria:
            # - FaceID inference –Ω–∞ –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏ Realistic Vision V5.1 (690204)
            # - LoRA inference –Ω–∞ –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏ Flux1.dev (1504944) - —Ç–∞ –∂–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å LoRA
            # Tune ID (FaceID/LoRA) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ–º–ø—Ç–µ –∫–∞–∫ <faceid:...> –∏–ª–∏ <lora:...>
            logger.info(f"[ASTRIA] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: use_lora={use_lora}, inpaint_faces={use_inpaint_faces}, tune_type={tune_type}")
            astria_res = await astria_run_prompt_and_wait(
                api_key=settings.astria_api_key,
                tune_id=base_model_tune_id,  # –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏, –ù–ï FaceID/LoRA tune!
                text=text,
                negative_prompt=neg,  # None –¥–ª—è LoRA (Flux –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
                input_image_bytes=None,  # text-to-image, –Ω–µ img2img
                cfg_scale=use_cfg_scale,
                steps=use_steps,
                denoising_strength=None,  # –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è text-to-image
                super_resolution=super_resolution,
                hires_fix=None,  # –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è FaceID
                face_correct=use_face_correct if use_lora else use_face_correct,
                face_swap=use_face_swap if use_lora else use_face_swap,
                inpaint_faces=use_inpaint_faces,  # True –¥–ª—è LoRA, None –¥–ª—è FaceID (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
                style=None,  # –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π style
                color_grading=use_color_grading,
                film_grain=use_film_grain,
                seed=use_seed,  # None –¥–ª—è Flux 2 Pro LoRA, random_seed –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                max_seconds=settings.astria_max_seconds,
                poll_seconds=2.0,
            )
            await bot.edit_message_text(chat_id=chat_id, message_id=status_message_id, text="–°–∫–∞—á–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶")
            out_bytes = await astria_download_first_image_bytes(astria_res.images, api_key=settings.astria_api_key)
            out_bytes = _postprocess_output(style_id, out_bytes)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–£–ª—É—á—à–∏—Ç—å" (—Ç–æ–ª—å–∫–æ –¥–ª—è LoRA) - –î–û —Å–æ–∑–¥–∞–Ω–∏—è bio
            if use_lora and context:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é –±–∞–π—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å—Å—ã–ª–∫—É
                context.user_data[USERDATA_LAST_ASTRIA_RESULT_BYTES] = out_bytes.copy() if hasattr(out_bytes, 'copy') else bytes(out_bytes)
                logger.info(f"[Astria] –°–æ—Ö—Ä–∞–Ω–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ '–£–ª—É—á—à–∏—Ç—å' (—Ä–∞–∑–º–µ—Ä: {len(out_bytes)} –±–∞–π—Ç)")
            
            bio = io.BytesIO(out_bytes)
            bio.name = f"{settings.app_name}_{style.id}.png"
            await bot.edit_message_text(chat_id=chat_id, message_id=status_message_id, text="–û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram‚Ä¶")
            tune_type_label = "LoRA" if use_lora else "FaceID"
            
            await _safe_send_document(
                bot=bot,
                chat_id=chat_id,
                document=bio,
                caption=f"–ì–æ—Ç–æ–≤–æ (Astria {tune_type_label}): ¬´{style.title}¬ª",
            )
            
            # –î–ª—è LoRA –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–£–ª—É—á—à–∏—Ç—å"
            logger.info(f"[Astria] –ü—Ä–æ–≤–µ—Ä–∫–∞ use_lora –¥–ª—è –∫–Ω–æ–ø–∫–∏ '–£–ª—É—á—à–∏—Ç—å': use_lora={use_lora}")
            if use_lora:
                logger.info(f"[Astria] –û—Ç–ø—Ä–∞–≤–ª—è—é –∫–Ω–æ–ø–∫—É '–£–ª—É—á—à–∏—Ç—å' –¥–ª—è chat_id={chat_id}")
                improve_keyboard = InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚ú® –£–ª—É—á—à–∏—Ç—å", callback_data="pl_improve_seedream")]
                ])
                try:
                    sent_msg = await bot.send_message(
                        chat_id=chat_id,
                        text="–ú–æ–∂–µ–º —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∏ —É–±—Ä–∞—Ç—å –ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ—Å—Ç—å —á–µ—Ä–µ–∑ Seedream 4.5",
                        reply_markup=improve_keyboard,
                    )
                    logger.info(f"[Astria] –ö–Ω–æ–ø–∫–∞ '–£–ª—É—á—à–∏—Ç—å' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ, message_id={sent_msg.message_id}")
                except Exception as e:
                    logger.error(f"[Astria] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–Ω–æ–ø–∫–∏ '–£–ª—É—á—à–∏—Ç—å': {e}", exc_info=True)
            else:
                logger.warning(f"[Astria] use_lora=False, –∫–Ω–æ–ø–∫–∞ '–£–ª—É—á—à–∏—Ç—å' –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è")
            
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text="–ì–æ—Ç–æ–≤–æ. –•–æ—á–µ—à—å –¥—Ä—É–≥–æ–π —Å—Ç–∏–ª—å?",
                reply_markup=_styles_keyboard(),
            )
            return

        logger.warning("Astria error: %s", e)
        await bot.edit_message_text(chat_id=chat_id, message_id=status_message_id, text=f"–û—à–∏–±–∫–∞ Astria: {e}")
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ PrismaLab job: %s", e, exc_info=True)
        try:
            short = (str(e) or "").strip().replace("\n", " ")
            if len(short) > 140:
                short = short[:140] + "‚Ä¶"
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text=f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.\n\n(–ö–æ—Ä–æ—Ç–∫–æ: {type(e).__name__}: {short or 'unknown'})",
            )
        except Exception:
            pass


async def handle_kie_test_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è KIE API (—Ä–∞–∑–Ω—ã–µ –º–æ–¥–µ–ª–∏)"""
    query = update.callback_query
    if not query:
        return
    await query.answer()
    
    # –ü–∞—Ä—Å–∏–º –º–æ–¥–µ–ª—å –∏–∑ callback_data: "pl_kie_test:model_name" –∏–ª–∏ "pl_kie_test:model_name:param" –∏–ª–∏ "pl_kie_test" (–¥–µ—Ñ–æ–ª—Ç)
    data = query.data or ""
    upscale_factor_from_button = None
    if ":" in data:
        parts = data.split(":", 2)
        model_name = parts[1]
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä - —ç—Ç–æ upscale_factor –¥–ª—è Topaz
        if len(parts) > 2:
            upscale_factor_from_button = parts[2]
    else:
        model_name = "nano-banana-pro"  # –î–µ—Ñ–æ–ª—Ç
    
    # –ù–∞–∑–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∏ –∏—Ö –ª–µ–π–±–ª—ã
    model_labels = {
        "google/imagen4-ultra": "üöÄ Imagen4 Ultra",
        "flux-2/pro-image-to-image": "‚ö° Flux Pro Img2Img",
        "flux-2/flex-image-to-image": "‚ö° Flux Flex Img2Img",
        "flux-2/flex-text-to-image": "‚ö° Flux Flex T2I",
        "flux-2/pro-text-to-image": "‚ö° Flux Pro T2I",
        "ideogram/v3-text-to-image": "üé® Ideogram V3 T2I",
        "ideogram/v3-edit": "‚úèÔ∏è Ideogram V3 Edit",
        "ideogram/v3-remix": "üîÑ Ideogram V3 Remix",
        "ideogram/character": "üë§ Character",
        "ideogram/character-edit": "‚úèÔ∏è Character Edit",
        "ideogram/character-remix": "üîÑ Character Remix",
        "topaz/image-upscale": "üîç Topaz Upscale",
        "recraft/crisp-upscale": "üîç Crisp Upscale",
        "nano-banana-pro": "üçå Nano Banana Pro",
        "seedream/4.5-edit": "üé® Seedream 4.5",
        "seedream/4.5-text-to-image": "üé® Seedream 4.5",
    }
    # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è
    model_label = model_labels.get(model_name, f"KIE {model_name}")
    
    settings = load_settings()
    if not settings.kie_api_key:
        await query.edit_message_text(
            "‚ùå KIE API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ù—É–∂–µ–Ω PRISMALAB_KIE_API_KEY.",
        )
        return
    
    # –î–ª—è Nano Banana –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ñ–æ—Ç–æ (–æ–±—ã—á–Ω—ã–µ –∏ multi)
    # –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–µ —Ñ–æ—Ç–æ (USERDATA_PHOTO_FILE_IDS)
    photo_file_ids = list(context.user_data.get(USERDATA_PHOTO_FILE_IDS, []))
    
    if not photo_file_ids:
        await query.edit_message_text("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ, –ø–æ—Ç–æ–º –Ω–∞–∂–∏–º–∞–π –∫–Ω–æ–ø–∫—É.")
        return
    
    if context.user_data.get(USERDATA_JOB_LOCK):
        await query.edit_message_text("–Ø –µ—â—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø—Ä–æ—à–ª—ã–π –∑–∞–ø—Ä–æ—Å. –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ‚Ä¶")
        return
    context.user_data[USERDATA_JOB_LOCK] = True
    
    status_msg = await query.message.reply_text(f"{model_label} –ó–∞–ø—É—Å–∫–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ KIE‚Ä¶")
    
    async def runner():
        try:
            bot = context.bot
            chat_id = query.message.chat_id
            status_message_id = status_msg.message_id
            
            # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text="üì• –°–∫–∞—á–∏–≤–∞—é —Ç–≤–æ—ë —Ñ–æ—Ç–æ‚Ä¶",
            )
            
            # –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ (—Å–∞–º–æ–µ —Å–≤–µ–∂–µ–µ) —Ñ–æ—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞
            photo_file_id = photo_file_ids[-1] if photo_file_ids else None
            if not photo_file_id:
                await bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=status_message_id,
                    text="‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ. –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –∑–∞–Ω–æ–≤–æ.",
                )
                return
            photo_bytes = await _safe_get_file_bytes(bot, photo_file_id)
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –≤ KIE –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text="üì§ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ –≤ KIE‚Ä¶",
            )
            
            import secrets
            random_id = secrets.token_hex(8)
            uploaded_url = await asyncio.to_thread(
                kie_upload_file_base64,
                api_key=settings.kie_api_key,
                image_bytes=photo_bytes,
                file_name=f"user_photo_{random_id}.jpg",
                upload_path="user-uploads",
                timeout_s=60.0,
            )
            
            logger.info(f"KIE: —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, URL: {uploaded_url}")
            
            # –ü—Ä–æ–º–ø—Ç –¥–ª—è Character, Seedream –∏ Nano Banana
            if "ideogram/character" in model_name.lower() or "seedream/4.5-text-to-image" in model_name.lower() or "nano-banana-pro" in model_name.lower():
                test_prompt = (
                    """IDENTICAL FACE AND FEATURES from reference photo, same skin tone, ultra high detail face. A dramatic urban portrait bathed in cool blue neon light from unseen city signs. The woman wears a sleek black turtleneck, rain droplets glistening on her shoulders. Hard side lighting carves sharp shadows across her cheekbones and jawline, while distant street lights create bokeh orbs in the background. Her direct, unflinching gaze holds both vulnerability and strength, captured in crisp high-contrast that emphasizes every subtle facial detail"""
                )
            else:
                # –ï–¥–∏–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —è–∑—ã–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å NSFW —Ñ–∏–ª—å—Ç—Ä–æ–≤
                test_prompt = (
                    "Place the person from the uploaded portrait, wearing a casual white blouse, in a peaceful garden setting. "
                    "The scene should feature vibrant green plants and colorful flowers, with soft sunlight filtering through the leaves. "
                    "The person should be sitting on a wooden bench, holding a book and smiling gently. "
                    "The background should be filled with lush greenery, with a serene, tranquil atmosphere. "
                    "Golden afternoon light should highlight the person's face and create soft shadows on the ground, "
                    "adding a peaceful, reflective mood to the scene. Professional photography, family-friendly, safe for work."
                )
            negative_prompt = (
                "blurry, lowres, bad quality, low quality, jpeg artifacts, out of focus, "
                "deformed face, face distortion, changed facial features, different person, "
                "asymmetrical eyes, duplicated face, two faces, multiple people, "
                "plastic skin, doll face, over-smooth skin, "
                "cartoon, anime, illustration, text, watermark, logo"
            )
            
            # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É, –Ω–æ –æ–Ω–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            if False:  # –û—Ç–∫–ª—é—á–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤—ã—à–µ
                # –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º NYC –¥–ª—è –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π
                nyc_style = get_style("nyc_70s")
                if nyc_style:
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–º–ø—Ç NYC –¥–ª—è –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π
                    test_prompt = f"{nyc_style.prompt}, preserve the person's face and identity from the reference image, photorealistic, high detail"
                    negative_prompt = nyc_style.negative_prompt or None
                else:
                    # Fallback, –µ—Å–ª–∏ —Å—Ç–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
                    test_prompt = (
                        "Cinematic vintage 35mm film photo, 1970s New York City street scene at night after rain. "
                        "A single person standing near a classic 1970s American car parked on the curb. "
                        "Wet asphalt, warm street lamps, soft reflections on the road, subtle fog in the distance. "
                        "Brick buildings with fire escapes, vintage shop signs, blurred taxi lights, distant skyline. "
                        "Kodak film look: natural skin texture, soft warm tones, slightly faded colors, authentic film grain, "
                        "dust, tiny scratches, subtle light leaks. "
                        "Candid documentary photo, realistic, photorealistic, high detail. "
                        "85mm lens, shallow depth of field, cinematic lighting. "
                        "Keep the same person and recognizable facial features. Preserve the person's face and identity from the reference image."
                    )
                    negative_prompt = (
                        "blurry, lowres, bad quality, low quality, jpeg artifacts, out of focus, "
                        "deformed face, face distortion, changed facial features, different person, "
                        "asymmetrical eyes, duplicated face, two faces, multiple people, "
                        "plastic skin, doll face, over-smooth skin, "
                        "cartoon, anime, illustration, text, watermark, logo"
                    )
            
            logger.info(f"KIE: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è {model_name} (–¥–ª–∏–Ω–∞ {len(test_prompt)}): {test_prompt[:100]}...")
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
            use_upscale_factor = None
            
            # –î–ª—è upscale –º–æ–¥–µ–ª–µ–π –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –î–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            if "upscale" in model_name.lower() or "topaz" in model_name.lower() or "recraft" in model_name.lower():
                if "topaz" in model_name.lower():
                    use_upscale_factor = upscale_factor_from_button if upscale_factor_from_button else "2"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            prompt_preview = test_prompt[:100] + "..." if len(test_prompt) > 100 else test_prompt
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –º–æ–¥–µ–ª–∏
            if "upscale" in model_name.lower() or "topaz" in model_name.lower() or "recraft" in model_name.lower():
                # –î–ª—è upscale –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
                factor_text = f" ({use_upscale_factor}x)" if use_upscale_factor else ""
                mode_text = f"upscale{factor_text}"
            elif "ideogram/character" in model_name.lower():
                mode_text = "character generation"
            elif "image-to-image" in model_name.lower() or "edit" in model_name.lower() or "remix" in model_name.lower():
                mode_text = "image-to-image"
            else:
                mode_text = "text-to-image"
            # –î–ª—è upscale –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç (–µ–≥–æ –Ω–µ—Ç)
            status_text = f"{model_label} –ì–µ–Ω–µ—Ä–∏—Ä—É—é —á–µ—Ä–µ–∑ KIE ({mode_text})\n\n"
            if not ("upscale" in model_name.lower() or "topaz" in model_name.lower() or "recraft" in model_name.lower()):
                status_text += f"üìù –ü—Ä–æ–º–ø—Ç: {prompt_preview}\n\n"
            status_text += f"‚è± –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 —Å–µ–∫—É–Ω–¥."
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text=status_text,
            )
            
            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞
            use_model_name = model_name
            if "google/imagen4-ultra" in model_name.lower():
                # Imagen4 Ultra - —Ç–æ–ª—å–∫–æ text-to-image
                use_resolution = None
                use_quality = None
                use_aspect_ratio = "1:1"
                use_image_input = None  # –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç image-to-image
                logger.info(f"KIE: –∏—Å–ø–æ–ª—å–∑—É–µ–º Imagen4 Ultra (text-to-image only)")
            elif "flux-2" in model_name.lower():
                # Flux-2 –º–æ–¥–µ–ª–∏
                use_resolution = "2K"
                use_quality = None
                use_aspect_ratio = "1:1"  # Flux-2 –¢–†–ï–ë–£–ï–¢ aspect_ratio (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)
                if "image-to-image" in model_name.lower():
                    use_image_input = [uploaded_url]  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ input_urls
                else:
                    use_image_input = None  # Text-to-image –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                logger.info(f"KIE: –∏—Å–ø–æ–ª—å–∑—É–µ–º Flux-2 –º–æ–¥–µ–ª—å {model_name}")
            elif "ideogram/v3" in model_name.lower():
                # Ideogram V3 –º–æ–¥–µ–ª–∏
                use_resolution = None
                use_quality = None
                use_aspect_ratio = None  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è image_size
                if "edit" in model_name.lower() or "remix" in model_name.lower():
                    use_image_input = [uploaded_url]  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ image_url (–æ–¥–∏–Ω URL)
                else:
                    use_image_input = None  # Text-to-image –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                logger.info(f"KIE: –∏—Å–ø–æ–ª—å–∑—É–µ–º Ideogram V3 –º–æ–¥–µ–ª—å {model_name}")
            elif "ideogram/character" in model_name.lower():
                # Ideogram Character –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç reference_image_urls –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—Ü–∞
                use_resolution = None  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Ideogram
                use_quality = None  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Ideogram
                use_aspect_ratio = None  # Ideogram –∏—Å–ø–æ–ª—å–∑—É–µ—Ç image_size –≤–º–µ—Å—Ç–æ aspect_ratio
                use_image_input = [uploaded_url]  # –ü–µ—Ä–µ–¥–∞—ë–º –∫–∞–∫ reference_image_urls
                logger.info(f"KIE: –∏—Å–ø–æ–ª—å–∑—É–µ–º Ideogram Character –º–æ–¥–µ–ª—å {model_name} —Å reference_image_urls")
            elif "upscale" in model_name.lower() or "topaz" in model_name.lower() or "recraft" in model_name.lower():
                # Upscale –º–æ–¥–µ–ª–∏ - —É–ª—É—á—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ (—Ä–µ—Ñ–∞) –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
                use_resolution = None
                use_quality = None
                use_aspect_ratio = None
                use_image_input = [uploaded_url]  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ image_url –∏–ª–∏ image
                # –î–ª—è Topaz –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤—ã—à–µ (–≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏), –¥–ª—è Recraft –Ω–µ –Ω—É–∂–µ–Ω
                logger.info(f"KIE: –∏—Å–ø–æ–ª—å–∑—É–µ–º Upscale –º–æ–¥–µ–ª—å {model_name} (factor: {use_upscale_factor}) –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ")
            elif "seedream" in model_name.lower():
                # Seedream 4.5 –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                use_resolution = None  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Seedream
                use_quality = "high"  # basic (2K) –∏–ª–∏ high (4K)
                use_aspect_ratio = "1:1"
                # –î–ª—è image-to-image –∏—Å–ø–æ–ª—å–∑—É–µ–º edit –≤–µ—Ä—Å–∏—é, –¥–ª—è text-to-image - –±–µ–∑ image_urls
                # –ï—Å–ª–∏ —ç—Ç–æ text-to-image, –Ω–æ –Ω—É–∂–µ–Ω reference - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ edit
                if "text-to-image" in model_name.lower() and uploaded_url:
                    # Text-to-image –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç image_urls, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ edit
                    logger.info(f"KIE: text-to-image –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç image_urls, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ edit –≤–µ—Ä—Å–∏—é")
                    use_model_name = "seedream/4.5-edit"
                    use_image_input = [uploaded_url]
                elif "edit" in model_name.lower():
                    use_image_input = [uploaded_url]
                else:
                    use_image_input = None
            else:
                # Nano Banana –∏ –¥—Ä—É–≥–∏–µ
                use_resolution = "2K"
                use_quality = None
                use_aspect_ratio = "1:1"
                # –î–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω–æ —Ñ–æ—Ç–æ
                use_image_input = [uploaded_url]
            
            # –î–ª—è upscale –º–æ–¥–µ–ª–µ–π –ø—Ä–æ–º–ø—Ç –Ω–µ –Ω—É–∂–µ–Ω (–æ–Ω–∏ —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
            # –ü–µ—Ä–µ–¥–∞—ë–º None –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –ø—Ä–æ–º–ø—Ç –Ω–µ –¥–æ–±–∞–≤–ª—è–ª—Å—è –≤ input_data
            is_upscale = "upscale" in model_name.lower() or "topaz" in model_name.lower() or "recraft" in model_name.lower()
            use_prompt = test_prompt if not is_upscale else None
            use_negative_prompt = negative_prompt if not is_upscale else None
            
            # –î–ª—è Topaz upscale_factor –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω - —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if "topaz" in use_model_name.lower() and not use_upscale_factor:
                use_upscale_factor = "2"  # –î–µ—Ñ–æ–ª—Ç –¥–ª—è Topaz
                logger.warning(f"KIE: use_upscale_factor –±—ã–ª None –¥–ª—è Topaz, —É—Å—Ç–∞–Ω–æ–≤–∏–ª –¥–µ—Ñ–æ–ª—Ç 2x")
            
            logger.info(f"KIE: —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è {use_model_name}: upscale_factor={use_upscale_factor}, prompt={'–µ—Å—Ç—å' if use_prompt else '–Ω–µ—Ç'}, image_input={'–µ—Å—Ç—å' if use_image_input else '–Ω–µ—Ç'}")
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ KIE API —Å reference image (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            kie_result = await kie_run_task_and_wait(
                api_key=settings.kie_api_key,
                model=use_model_name,
                prompt=use_prompt,
                image_input=use_image_input,
                aspect_ratio=use_aspect_ratio,
                resolution=use_resolution,
                quality=use_quality,
                negative_prompt=use_negative_prompt,
                output_format="png",
                upscale_factor=use_upscale_factor,
                max_seconds=300,
                poll_seconds=3.0,
            )
            
            if not kie_result.image_url:
                await bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=status_message_id,
                    text="‚ùå KIE –≤–µ—Ä–Ω—É–ª –∑–∞–¥–∞—á—É –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
                )
                return
            
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text="–°–∫–∞—á–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶",
            )
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            image_bytes = await asyncio.to_thread(
                kie_download_image_bytes,
                kie_result.image_url,
                timeout_s=30.0,
            )
            
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=status_message_id,
                text="–û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram‚Ä¶",
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            import io
            bio = io.BytesIO(image_bytes)
            # –û—á–∏—â–∞–µ–º –∏–º—è –º–æ–¥–µ–ª–∏ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            safe_model_name = model_name.replace("/", "_").replace(":", "_")
            bio.name = f"{settings.app_name}_kie_{safe_model_name}.png"
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –¥–ª—è caption
            if "upscale" in model_name.lower() or "topaz" in model_name.lower() or "recraft" in model_name.lower():
                mode_text = "upscale"
            elif "ideogram/character" in model_name.lower():
                mode_text = "character generation"
            elif "image-to-image" in model_name.lower() or "edit" in model_name.lower() or "remix" in model_name.lower():
                mode_text = "image-to-image"
            else:
                mode_text = "text-to-image"
            await _safe_send_document(
                bot=bot,
                chat_id=chat_id,
                document=bio,
                caption=f"{model_label} –ì–æ—Ç–æ–≤–æ (KIE, {mode_text})",
            )
            
            await bot.delete_message(chat_id=chat_id, message_id=status_message_id)
            
        except KieError as e:
            error_msg = str(e)
            logger.error(f"KIE –æ—à–∏–±–∫–∞: {error_msg}")
            
            # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ NSFW –æ—à–∏–±–∫–∏
            if "nsfw" in error_msg.lower():
                user_msg = (
                    "‚ùå KIE –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å –∫–∞–∫ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (NSFW).\n\n"
                    "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                    "‚Ä¢ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–¥–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º\n"
                    "‚Ä¢ –ü—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞\n\n"
                    "–ü–æ–ø—Ä–æ–±—É–π:\n"
                    "‚Ä¢ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ (–ø–æ—Ä—Ç—Ä–µ—Ç –≤ –æ–±—ã—á–Ω–æ–π –æ–¥–µ–∂–¥–µ)\n"
                    "‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å"
                )
            else:
                user_msg = f"‚ùå –û—à–∏–±–∫–∞ KIE: {error_msg}"
            
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text=user_msg,
            )
        except Exception as e:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ KIE —Ç–µ—Å—Ç–µ: {e}", exc_info=True)
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text=f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.\n(–ö–æ—Ä–æ—Ç–∫–æ: {type(e).__name__}: {e})",
            )
        finally:
            context.user_data[USERDATA_JOB_LOCK] = False
    
    context.application.create_task(runner())


async def handle_astria_generate_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Astria (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è LoRA/FaceID)"""
    query = update.callback_query
    if not query:
        return
    await query.answer()
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, —á—Ç–æ –∏ –¥–ª—è —Å—Ç–∏–ª–µ–π, –Ω–æ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º style_id="test"
    # –≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ Astria —Å –µ–¥–∏–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    context.user_data["pl_last_style_id"] = "test"
    
    # –î–ª—è Astria –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LoRA/FaceID –∏–∑ –±–∞–∑—ã
    # –ù–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö, –µ—Å–ª–∏ –Ω–µ—Ç - —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å LoRA/FaceID
    photo_file_ids = list(context.user_data.get(USERDATA_PHOTO_FILE_IDS, []))
    
    # –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ, –Ω–æ –µ—Å—Ç—å LoRA/FaceID - –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ LoRA/FaceID –≤ –±–∞–∑–µ
    user_id = int(query.from_user.id) if query.from_user else 0
    if not photo_file_ids and user_id:
        from prismalab.storage import PrismaLabStore
        store = PrismaLabStore()
        user_profile = store.get_user(user_id)
        if not user_profile or (not user_profile.astria_lora_tune_id and not user_profile.astria_tune_id):
            await query.edit_message_text(
                "‚ùå –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Astria –Ω—É–∂–Ω–æ:\n"
                "‚Ä¢ –õ–∏–±–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ\n"
                "‚Ä¢ –õ–∏–±–æ —Å–æ–∑–¥–∞—Ç—å LoRA (10 —Ñ–æ—Ç–æ) –∏–ª–∏ FaceID (1 —Ñ–æ—Ç–æ)"
            )
            return
    
    settings = load_settings()
    ps = _get_prompt_strength(settings, context)
    uid = int(query.from_user.id) if query.from_user else 0
    gender = context.user_data.get(USERDATA_SUBJECT_GENDER)
    use_personal_requested = _is_personal_enabled(context)
    
    # –ü—Ä–æ–º–ø—Ç –ø—Ä–æ —Å–º–µ—é—â—É—é—Å—è –¥–µ–≤—É—à–∫—É
    test_prompt = (
        "same reference female character, candid laugh, head turned left, eyes squinting, looking away from camera, "
        "tropical greenery background, golden hour, realistic photo, 35mm, shallow depth of field. "
        "identity preserved, natural expression change, no face morphing, no distortion, correct anatomy, no extra fingers, no text"
    )
    
    status_msg = await query.message.reply_text("üåü Astria: –ó–∞–ø—É—Å–∫–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é‚Ä¶")
    
    await _run_style_job(
        bot=context.bot,
        chat_id=query.message.chat_id,
        photo_file_ids=photo_file_ids,
        style_id="test",
        settings=settings,
        status_message_id=status_msg.message_id,
        prompt_strength=ps,
        user_id=uid,
        subject_gender=gender,
        use_personal_requested=use_personal_requested,
        test_prompt=test_prompt,
        context=context,
    )


async def handle_improve_seedream_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–£–ª—É—á—à–∏—Ç—å' - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç Astria –≤ Seedream 4.5 Edit"""
    query = update.callback_query
    if not query:
        return
    await query.answer()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ
    result_bytes = context.user_data.get(USERDATA_LAST_ASTRIA_RESULT_BYTES)
    if not result_bytes:
        await query.edit_message_text("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Astria LoRA.")
        return
    
    settings = load_settings()
    if not settings.kie_api_key:
        await query.edit_message_text("‚ùå KIE API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ù—É–∂–µ–Ω PRISMALAB_KIE_API_KEY.")
        return
    
    status_msg = await query.message.reply_text("‚ú® –£–ª—É—á—à–∞—é –∫–∞—á–µ—Å—Ç–≤–æ —á–µ—Ä–µ–∑ Seedream 4.5‚Ä¶")
    
    bot = context.bot
    
    async def runner():
        try:
            context.user_data[USERDATA_JOB_LOCK] = True
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –≤ KIE
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text="–ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ –≤ KIE‚Ä¶",
            )
            
            import secrets
            random_id = secrets.token_hex(8)
            uploaded_url = await asyncio.to_thread(
                kie_upload_file_base64,
                api_key=settings.kie_api_key,
                image_bytes=result_bytes,
                file_name=f"improve_{random_id}.jpg",
                upload_path="user-uploads",
                timeout_s=60.0,
            )
            
            if not uploaded_url:
                await bot.edit_message_text(
                    chat_id=query.message.chat_id,
                    message_id=status_msg.message_id,
                    text="‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –≤ KIE.",
                )
                return
            
            # –ü—Ä–æ–º–ø—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
            improve_prompt = "fujifilm raw photo, detailed skin pores, hyper-realistic, 8k, cinematic film grain, slight camera noise"
            
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text="–ì–µ–Ω–µ—Ä–∏—Ä—É—é —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —á–µ—Ä–µ–∑ Seedream 4.5 Edit‚Ä¶",
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Seedream 4.5 Edit
            from prismalab.kie_client import run_task_and_wait
            
            kie_result = await run_task_and_wait(
                api_key=settings.kie_api_key,
                model="seedream/4.5-edit",
                prompt=improve_prompt,
                image_input=[uploaded_url],  # Seedream –∏—Å–ø–æ–ª—å–∑—É–µ—Ç image_urls
                aspect_ratio="1:1",
                quality="high",  # –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
                max_seconds=300,
                poll_seconds=3.0,
            )
            
            if not kie_result.image_url:
                await bot.edit_message_text(
                    chat_id=query.message.chat_id,
                    message_id=status_msg.message_id,
                    text="‚ùå Seedream –Ω–µ –≤–µ—Ä–Ω—É–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.",
                )
                return
            
            # –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text="–°–∫–∞—á–∏–≤–∞—é —É–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ‚Ä¶",
            )
            
            import requests
            img_response = requests.get(kie_result.image_url, timeout=60)
            img_response.raise_for_status()
            improved_bytes = img_response.content
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            bio = io.BytesIO(improved_bytes)
            bio.name = f"{settings.app_name}_improved.png"
            
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text="–û—Ç–ø—Ä–∞–≤–ª—è—é —É–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ‚Ä¶",
            )
            
            await _safe_send_document(
                bot=bot,
                chat_id=query.message.chat_id,
                document=bio,
                caption="‚ú® –£–ª—É—á—à–µ–Ω–æ —á–µ—Ä–µ–∑ Seedream 4.5 Edit",
            )
            
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text="‚úÖ –ì–æ—Ç–æ–≤–æ! –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–æ.",
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ Seedream: {e}", exc_info=True)
            await bot.edit_message_text(
                chat_id=query.message.chat_id,
                message_id=status_msg.message_id,
                text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏: {str(e)[:200]}",
            )
        finally:
            context.user_data[USERDATA_JOB_LOCK] = False
    
    context.application.create_task(runner())


async def handle_style_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query:
        return
    await query.answer()

    data = query.data or ""
    if not data.startswith("pl_style:"):
        return
    style_id = data.split(":", 1)[1]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ KIE
    context.user_data["pl_last_style_id"] = style_id

    photo_file_ids = list(context.user_data.get(USERDATA_PHOTO_FILE_IDS, []))
    if not photo_file_ids:
        await query.edit_message_text("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ, –ø–æ—Ç–æ–º –≤—ã–±–∏—Ä–∞–π —Å—Ç–∏–ª—å.")
        return

    # –î–ª—è –∫–Ω–æ–ø–∫–∏ "–¢–µ—Å—Ç" - —á–µ—Ä–µ–∑ Astria
    if style_id == "test":
        if context.user_data.get(USERDATA_JOB_LOCK):
            await query.edit_message_text("–Ø –µ—â—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø—Ä–æ—à–ª—ã–π –∑–∞–ø—Ä–æ—Å. –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ‚Ä¶")
            return
        context.user_data[USERDATA_JOB_LOCK] = True
        status_msg = await query.message.reply_text("–ü—Ä–∏–Ω—è–ª. –ó–∞–ø—É—Å–∫–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É‚Ä¶")
        settings = load_settings()
        ps = _get_prompt_strength(settings, context)
        uid = int(query.from_user.id) if query.from_user else 0
        gender = context.user_data.get(USERDATA_SUBJECT_GENDER)
        use_personal_requested = _is_personal_enabled(context)
        test_prompt = "–≠—Ç–æ—Ç –º–æ–ª–æ–¥–æ–π —á–µ–ª–æ–≤–µ–∫ —Å—Ç–æ–∏—Ç –≤ —Ç–µ–º–Ω–æ–º –∫–æ—Å—Ç—é–º–µ –≤–æ–∑–ª–µ –Ω–µ–±–æ—Å—Ä–∫–µ–±–∞ –∏–∑ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–µ–∫–ª–∞. –†—è–¥–æ–º —Å—Ç–æ–∏—Ç —á–µ—Ä–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å. –ù–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ –¥–ª–∏–Ω–Ω–∞—è —É–ª–∏—Ü–∞ —É—Ö–æ–¥—è—â–∞—è –≤–¥–∞–ª—å. –°–æ–ª–Ω–µ—á–Ω–∞—è –ø–æ–≥–æ–¥–∞."
        context.user_data[USERDATA_USE_PERSONAL] = False

        async def runner():
            try:
                await _run_style_job(
                    bot=context.bot,
                    chat_id=query.message.chat_id,
                    photo_file_ids=photo_file_ids,
                    style_id=style_id,
                    settings=settings,
                    status_message_id=status_msg.message_id,
                    prompt_strength=ps,
                    user_id=uid,
                    subject_gender=gender,
                    use_personal_requested=use_personal_requested,
                    test_prompt=test_prompt,
                    context=context,
                )
            finally:
                context.user_data[USERDATA_JOB_LOCK] = False

        context.application.create_task(runner())
        return
    
    # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π - —á–µ—Ä–µ–∑ Astria
    # KIE –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ç–∏–ª—å
    if context.user_data.get(USERDATA_JOB_LOCK):
        await query.edit_message_text("–Ø –µ—â—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø—Ä–æ—à–ª—ã–π –∑–∞–ø—Ä–æ—Å. –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ‚Ä¶")
        return
    context.user_data[USERDATA_JOB_LOCK] = True

    status_msg = await query.message.reply_text("–ü—Ä–∏–Ω—è–ª. –ó–∞–ø—É—Å–∫–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É‚Ä¶")
    settings = load_settings()
    ps = _get_prompt_strength(settings, context)
    uid = int(query.from_user.id) if query.from_user else 0
    gender = context.user_data.get(USERDATA_SUBJECT_GENDER)
    use_personal_requested = _is_personal_enabled(context)

    async def runner():
        try:
            await _run_style_job(
                bot=context.bot,
                chat_id=query.message.chat_id,
                photo_file_ids=photo_file_ids,
                style_id=style_id,
                settings=settings,
                status_message_id=status_msg.message_id,
                prompt_strength=ps,
                user_id=uid,
                subject_gender=gender,
                use_personal_requested=use_personal_requested,
                test_prompt=None,
                context=context,
            )
        finally:
            context.user_data[USERDATA_JOB_LOCK] = False

    context.application.create_task(runner())


def main() -> None:
    settings = load_settings()
    if not settings.bot_token:
        raise ValueError("PRISMALAB_BOT_TOKEN (–∏–ª–∏ BOT_TOKEN) –Ω–µ –Ω–∞–π–¥–µ–Ω")

    application = Application.builder().token(settings.bot_token).build()

    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("restart", restart_command))
    application.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    application.add_handler(MessageHandler(filters.Document.IMAGE, handle_document))
    application.add_handler(CallbackQueryHandler(handle_prompt_strength_callback, pattern="^pl_ps:"))
    application.add_handler(CallbackQueryHandler(handle_gender_callback, pattern="^pl_gender:"))
    application.add_handler(CallbackQueryHandler(handle_personal_toggle_callback, pattern="^pl_personal:"))
    application.add_handler(CallbackQueryHandler(handle_astria_faceid_callback, pattern="^pl_astria_faceid$"))
    application.add_handler(CallbackQueryHandler(handle_astria_lora_callback, pattern="^pl_astria_lora$"))
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ handle_nano_banana_multi_callback —É–¥–∞–ª—ë–Ω - –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    application.add_handler(CallbackQueryHandler(handle_reset_callback, pattern="^pl_reset$"))
    application.add_handler(CallbackQueryHandler(handle_style_callback, pattern="^pl_style:"))
    application.add_handler(CallbackQueryHandler(handle_astria_generate_callback, pattern="^pl_astria_generate$"))
    application.add_handler(CallbackQueryHandler(handle_improve_seedream_callback, pattern="^pl_improve_seedream$"))
    application.add_handler(CallbackQueryHandler(handle_kie_test_callback, pattern="^pl_kie_test"))

    logger.info("%s –∑–∞–ø—É—â–µ–Ω", settings.app_name)
    application.run_polling(drop_pending_updates=True)


if __name__ == "__main__":
    main()

